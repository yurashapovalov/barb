# ADR-011: Порядок и формат колонок в результатах

## Контекст

Результаты запросов возвращались с колонками в произвольном порядке (зависел от pandas). Timestamp всегда содержал время (`2025-04-06T00:00:00`), даже когда оно не нужно (weekly, daily).

Проблемы:
- `timestamp` в конце, а не в начале
- Порядок OHLC случайный (`low, high, open, close` вместо `open, high, low, close`)
- Время `T00:00:00` в weekly данных — мусор

## Решение

1. **Разделить timestamp** на `date` + `time` в зависимости от таймфрейма
2. **Фиксированный приоритет** колонок: date → time → group_keys → OHLC → volume → calculated

### Разделение timestamp

| Timeframe | Результат |
|-----------|-----------|
| 1m, 5m, 15m, 30m, 1h, 2h, 4h | `date` + `time` |
| daily, weekly, monthly+ | только `date` |

Форматы: `date` = `2024-03-15`, `time` = `09:30`

### Приоритет колонок

```
date → time → group_by → open → high → low → close → volume → map_columns → остальные
```

## Почему

- **date первая** — это идентификатор строки, главный контекст
- **time отдельно** — для intraday важно видеть время, для daily+ оно не нужно
- **OHLC в стандартном порядке** — общепринятый в индустрии
- **calculated в конце** — это дополнительные данные, не основные

## Реализация

Функция `_prepare_for_output()` в `barb/interpreter.py`:
- Вызывается перед сериализацией в JSON
- Разбивает timestamp, переупорядочивает колонки
- Применяется и к `table`, и к `source_rows`

## Последствия

- Порядок колонок стабилен и предсказуем
- Frontend может полагаться на порядок (не нужно сортировать)
- Формат даты/времени человекочитаемый
