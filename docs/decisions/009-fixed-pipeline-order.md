# ADR-009: Фиксированный порядок выполнения запроса

## Контекст

Запрос — это JSON с полями: session, period, from, map, where, group_by, select, sort, limit. Нужно было решить в каком порядке выполнять шаги.

## Решение

Фиксированный pipeline из 9 шагов, всегда в одном порядке:

```
session → period → from → map → where → group_by → select → sort → limit
```

Порядок ключей в JSON не влияет на выполнение.

## Почему фиксированный

- Предсказуемость. `where` после `map` означает что в where можно использовать вычисленные колонки. Это всегда так, не зависит от порядка записи.
- LLM не нужно думать о порядке. Пишет JSON в любом порядке — результат один.
- Проще отлаживать. Ошибка на шаге `map` — значит session, period, from уже отработали.

## Почему именно такой порядок

- session/period/from — фильтрация и агрегация сырых данных. Сначала отрезаем лишнее.
- map — вычисленные колонки. Нужны данные после from (OHLCV по таймфрейму).
- where — фильтр строк. Может использовать колонки из map.
- group_by + select — агрегация. Работает над отфильтрованными данными.
- sort + limit — финальное оформление результата.

Это SQL-подобная логика: FROM → WHERE → GROUP BY → SELECT → ORDER BY → LIMIT.

## Последствия

- Нельзя фильтровать до map (where не видит map-колонки до их создания) — но это и не нужно
- Нельзя сделать "вложенные" запросы или подзапросы — осознанное ограничение
- QueryError указывает шаг где произошла ошибка — легко понять что пошло не так
