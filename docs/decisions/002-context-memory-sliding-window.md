# ADR-002: Контекстная память — sliding window + summary

## Контекст

Нужна стратегия управления историей разговора для Gemini. Каждая сессия (conversation) — чистый лист, между сессиями ничего не помним.

В контекст Gemini попадает только текст (role + content). Таблицы данных, tool calls и их результаты хранятся в DB для фронта, но в контекст не попадают. Это значит контекст лёгкий — 20 обменов ≈ 3-5k токенов.

## Решение

Sliding window + summary. Первые 20 обменов — полная история. После 20 — суммаризируем старое, храним summary в `conversations.context` (jsonb).

```
Gemini получает:
  system_prompt
  + summary (если есть)
  + последние N сообщений
  + новый вопрос юзера
```

## Альтернативы

- RAG с embeddings — индексировать историю, искать релевантные фрагменты
- Только последние N сообщений без summary
- Полная история всегда (надеясь на 1M контекст Gemini)

## Почему так

- История — чистый текст, лёгкий. RAG это overkill
- Gemini 1M контекст хватит надолго, но summary страхует от edge cases
- Implicit caching Gemini автоматически кэширует повторяющийся system prompt
- Только последние N без summary — теряем контекст ранних вопросов
- Полная история без лимита — работает, но не масштабируется на длинные сессии

## Последствия

- Нужна колонка `context` (jsonb) в conversations — сделано
- Нужна логика суммаризации в API chat handler — отдельный вызов Gemini
- Качество summary влияет на качество ответов после порога
