# Query Engine (barb/)

Ядро системы. Принимает JSON-запрос, выполняет по шагам, возвращает результат.

## Как работает

Запрос — плоский JSON. Каждое поле — шаг пайплайна. Порядок выполнения фиксированный, не зависит от порядка полей в JSON.

```
Входные данные (минутный DataFrame)
    ↓
1. session    — фильтр по торговой сессии (RTH, ETH, OVERNIGHT...)
2. period     — фильтр по периоду (год, месяц, диапазон дат, "last_month")
3. from       — ресемплинг таймфрейма (1min → D, W, M)
4. map        — вычисляемые колонки (range, body, gap...)
5. where      — фильтр строк по условию
6. group_by   — группировка (по дню недели, месяцу...)
7. select     — выбор колонок + агрегация (mean, sum, count...)
8. sort       — сортировка результата
9. limit      — ограничение количества строк
    ↓
Результат (скаляр или таблица) + метаданные
```

## Модули

### interpreter.py
Оркестратор. Принимает `execute(query, df, sessions)`, прогоняет по шагам, возвращает результат с метаданными (кол-во строк, сессия, таймфрейм). Валидирует входные данные — неизвестные поля, невалидные таймфреймы, пустые запросы.

### expressions.py
Парсер и вычислитель выражений. Безопасный — никакого eval/exec. Строит AST из строки, вычисляет на DataFrame. Поддерживает: арифметику, сравнения, булевую логику, вызовы функций, литералы, ссылки на колонки.

### functions.py
Реестр 40+ функций. Категории:
- Скалярные — abs, log, round, if
- Лаговые — prev, next (сдвиг на N баров)
- Оконные — rolling_mean, rolling_sum, ema, atr
- Кумулятивные — cum_sum, cum_max, cum_min
- Паттерны — streak, bars_since, rank
- Агрегатные — mean, sum, count, max, min, std, median, percentile, correlation
- Временные — dayofweek, hour, month, year

### data.py
Загрузка Parquet файлов. Один файл = один инструмент. Кэшируется через lru_cache. Возвращает DataFrame с DatetimeIndex и колонками [open, high, low, close, volume].

## Пример

Запрос: "средний дневной диапазон RTH за 2024 год"

```json
{
  "session": "RTH",
  "period": "2024",
  "from": "D",
  "map": {"range": "high - low"},
  "select": ["range"],
  "agg": "mean"
}
```

Результат: `285.4` (скаляр) + метаданные (session=RTH, timeframe=D, rows=252).
